name: Rebuild maintained images

on:
  workflow_dispatch:
    inputs:
      minimal-supported-version:
        type: string
        description: 'Minimal supported version from which we should start checking images, e.g. 5.3, 5.4, 5.5. Default value is 5.3'
        required: false
  schedule:
    - cron: '0 6 * * *'

jobs:
  get-latest-patch-versions-to-rebuild:
    runs-on: ubuntu-latest
    name: Get latest patch versions since
    outputs:
      versions-count: ${{ steps.get-latest-patch-versions-to-rebuild.outputs.versions-count }}
      matrix: ${{ steps.get-latest-patch-versions-to-rebuild.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed image versions
        uses: ./.github/actions/get-latest-patch-versions-to-rebuild
        id: get-latest-patch-versions-to-rebuild
        with:
          since-version: ${{ inputs.minimal-supported-version || '5.3'  }}
          image-name: hazelcast/management-center

  rebuild:
    if: ${{ needs.get-latest-patch-versions-to-rebuild.outputs.versions-count > 0 }}
    name: Rebuild ${{ matrix.version }}
    needs: get-latest-patch-versions-to-rebuild
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.get-latest-patch-versions-to-rebuild.outputs.matrix) }}
    uses: ./.github/workflows/tag_image_push.yml
    with:
      dry-run: true
      tag: 'v${{ matrix.version }}'
    secrets: inherit
