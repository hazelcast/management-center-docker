name: Vulnerabilities Scan
on:
  workflow_dispatch:
  pull_request:
    paths:
      - .github/workflows/vulnerabilities_scan.yml
      - .snyk
      - Dockerfile
  push:
    branches:
      - master
  schedule:
    - cron: '0 2 * * *'

concurrency:
  group: scan-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  scan:
    name: Scan docker image
    env:
      IMAGE_NAME: phone-home:${{ github.sha }}
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2.3.0

      - name: Build
        uses: docker/build-push-action@v3
        with:
          context: .
          tags: ${{ env.IMAGE_NAME }}
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan image by Snyk
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.IMAGE_NAME }}
          json: true
          args: >-
            --file=Dockerfile
            --print-deps
            --exclude-base-image-vulns
            --policy-path=.snyk

      - name: Upload SNYK report
        uses: actions/upload-artifact@v3
        if: ${{ failure() }}
        with:
          name: SNYK dependency check report
          path: ${{github.workspace}}/snyk.json
